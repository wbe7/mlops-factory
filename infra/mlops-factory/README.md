# Helm-чарт приложения MLOps Factory

Этот документ описывает процесс развертывания и управления приложением предсказания MLOps Factory с использованием его Helm-чарта.

## Развертывание

Для развертывания или обновления приложения используйте следующую команду Helm:

```bash
helm upgrade --install mlops-factory infra/mlops-factory \
  --namespace mlops-factory \
  --create-namespace \
  -f infra/mlops-factory/values.yaml
```

**Примечание:** Убедитесь, что пространство имен `mlops-factory` существует и секрет `mlflow-tracking` (содержащий учетные данные MLflow) был скопирован в это пространство имен.

## Конфигурация

Основная конфигурация приложения находится в файле `infra/mlops-factory/values.yaml`. Ключевые параметры включают:

*   **`image.repository`**: Репозиторий Docker Hub (например, `wbe7/mlops-factory`).
*   **`image.tag`**: Тег образа Docker для развертывания (например, `v0.1.3`).
*   **`ingress.hosts`**: Имя хоста для доступа к приложению (например, `mlops-factory.cloudnative.space`).
*   **`env`**: Переменные окружения для отслеживания MLflow и загрузки модели.

## Обновление приложения (новый образ Docker)

Чтобы развернуть новую версию вашего приложения (например, после изменений в коде):

1.  **Сборка и публикация нового образа Docker:**
    *   Зафиксируйте изменения в коде.
    *   Создайте и отправьте новый git-тег (например, `v0.1.4`), чтобы запустить рабочий процесс GitHub Actions `publish.yml`.
    *   Убедитесь, что новый образ Docker (например, `wbe7/mlops-factory:v0.1.4`) успешно отправлен в Docker Hub.

2.  **Обновление значений Helm-чарта:**
    *   Отредактируйте `infra/mlops-factory/values.yaml` и обновите `image.tag` до новой версии (например, `v0.1.4`).
    *   (Необязательно) Обновите `appVersion` в `infra/mlops-factory/Chart.yaml`, чтобы он соответствовал новому тегу образа.

3.  **Развертывание обновленного чарта:**
    ```bash
    helm upgrade --install mlops-factory infra/mlops-factory \
      --namespace mlops-factory \
      -f infra/mlops-factory/values.yaml
    ```
    Helm выполнит скользящее обновление, развернув новую версию вашего приложения.

## Обновление ML-модели

Чтобы развернуть новую версию ML-модели (например, после переобучения):

1.  **Обучение и регистрация новой версии модели:**
    *   Убедитесь, что ваш скрипт `train.py` настроен на логирование в удаленный сервер MLflow.
    *   Запустите `dvc repro` (или запустите ваш рабочий процесс CI), чтобы обучить новую модель и зарегистрировать ее в реестре моделей MLflow.

2.  **Продвижение модели в пользовательском интерфейсе MLflow:**
    *   Получите доступ к пользовательскому интерфейсу MLflow по адресу `https://mlflow.cloudnative.space`.
    *   Перейдите в раздел "Models" и выберите `california-housing-model`.
    *   Найдите недавно зарегистрированную версию модели.
    *   Присвойте этой новой версии алиас `prod`.

3.  **Перезагрузка приложения:**
    *   Запущенные поды приложения будут продолжать обслуживать предсказания с использованием старой модели до их перезапуска.
    *   Чтобы принудительно загрузить новую модель, вы можете запустить скользящий перезапуск развертывания:
        ```bash
        kubectl rollout restart deployment/mlops-factory -n mlops-factory
        ```
    *   В качестве альтернативы, новая модель будет загружена автоматически во время следующего развертывания приложения или перезапуска пода.

## Доступ к приложению

Приложение будет доступно через Ingress по адресу: `https://mlops-factory.cloudnative.space`

## Устранение неполадок

*   **Перезапуски подов:** Проверьте логи подов (`kubectl logs <имя-пода> -n mlops-factory`) и события (`kubectl describe pod <имя-пода> -n mlops-factory`).
*   **Проблемы с загрузкой модели:** Проверьте логи сервера MLflow и убедитесь, что таймауты Ingress/Gunicorn достаточны.
*   **Проблемы с Ingress:** Проверьте события Ingress (`kubectl describe ingress mlops-factory -n mlops-factory`) и логи контроллера Ingress Nginx.
